/* eduardo - 07/01/2021 09:43:34 GMT */
var _headers={Accept:"application/vnd.vtex.ds.v10+json","Content-Type":"application/json"};var _last_sku;var _last_json;var _index;var _postalcode;var _ordenando=false;var _carregando=true;var LivroFacil_Checkout={data:{cookieRead:function(_name){var nameEQ=_name+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)===" "){c=c.substring(1,c.length)}if(c.indexOf(nameEQ)===0){return c.substring(nameEQ.length,c.length)}}return null},cookieCreate:function(_name,_value,_days){var d=new Date;d.setTime(d.getTime()+_days*1e3*60*60*24);var expires="expires="+d.toGMTString();window.document.cookie=_name+"="+_value+"; "+expires+";path=/"}},methods:{getDateShipping:function(){var _schools_id=LivroFacil_Checkout.data.cookieRead("_schools_id");if(_schools_id!=undefined&&_schools_id!=""){if(!$(".e-new-student").length){$("#cart-choose-more-products").before('<div class="e-new-student">Adicionar novo aluno</div>')}$.ajax({headers:_headers,type:"GET",url:"/api/dataentities/ES/documents/"+_schools_id+"?_fields=dtentregalista&an=livrofacil",success:function(data){var _dtentregalista=data.dtentregalista;if(_dtentregalista!=null&&_dtentregalista!=""){$("#cart-note").val(_dtentregalista).change();$("body").addClass("e-list-has-date");setTimeout(function(){if(!$("#shipping-data .e-date").length){$("#shipping-data .shipping-data .accordion-toggle").append('<span class="e-date">  no dia  '+_dtentregalista+"</span>")}},1e3)}}})}},newStudent:function(){var _schools_id=LivroFacil_Checkout.data.cookieRead("_schools_id");$("body").on("click",".e-new-student",function(event){var _url="/_secure/school/student?school="+_schools_id;window.location.href=_url})},orderAluno:function(callback){_this=this;var sort_by_name=function(c,d){var a=c[0];var b=d[0];if(typeof $(a).find(".e-student").html()=="undefined"&&typeof $(b).find(".e-student").html()=="undefined"){return 0}if(typeof $(a).find(".e-student").html()=="undefined"){return-1}if(typeof $(b).find(".e-student").html()=="undefined"){return 1}var sa=$(a).find(".e-student").html();var sb=$(b).find(".e-student").html();return sb>sa?-1:sb<sa?1:0};var listWithKO=[];var list=$(".product-item");$(list).each(function(){var sku=$(this).attr("data-sku");var helper=[];helper.push(this);$t=this;aux=0;for(var i=0;i<3;i++){$t=$t.nextSibling;if($t.nodeType==1){$($t).attr("data-sku",sku);helper.push($t);continue}else if($t.nodeValue.includes("/ko")){helper.push($t);break}}listWithKO.push(helper)});listWithKO.sort(sort_by_name);for(var i=0;i<listWithKO.length;i++){for(var j=0;j<listWithKO[i].length;j++){$(".cart-items tbody").append($(listWithKO[i][j]))}if(listWithKO.length==i+1){_ordenando=false;var seen={};var unavailableSeen={};$(".product-item").each(function(j,e){var txt=$(e).find(".e-student").html()+$(this).attr("data-sku");if(seen[txt])$(this).remove();else seen[txt]=true});$(".item-unavailable").each(function(j,e){var sku=$(this).attr("data-sku");if(unavailableSeen[sku])$(this).remove();else unavailableSeen[sku]=true});callback();$("table.cart-items tbody").append($(".qd-emptyCart"))}}},nameStudent:function(){if(_carregando)return;_this=this;$("#cartLoadedDiv .product-item").each(function(index,el){var _element=$(this);var _student=_element.nextAll().eq(1).find(".item-attachment-value").val();if(_student!=""&&_student!=undefined){var _student_name=_student.replace(/"/g,"").split("NomeAluno:")[1].split(";")[0];var _student_school=_student.replace(/"/g,"").split("Escola:")[1].split(";")[0];var _student_serie=_student.replace(/"/g,"").split("Serie:")[1].split(";")[0];if(_student_serie.indexOf("N/A")>-1)_student_serie=_student_serie.replace("º","");else _student_serie=_student_serie.replace("ºº","º");if(!_element.find(".e-student").length){_element.find(".product-name").append('<div class="e-student">Aluno: '+_student_name+" <br /> Série: "+_student_serie+" <br /> </div>")}}});_this.orderAluno(function(){_this.separadorAluno()});LivroFacil_Checkout.methods.discount()},remove:function(){$("body").on("click",".item-link-remove",function(event){var _element=$(this);var _sku=_element.closest(".product-item").attr("data-sku");var _json=_element.closest(".product-item").nextAll().eq(1).find(".item-attachment-value").val();_index=_element.closest(".product-item").index();_last_sku=_sku;_last_json=_json;$(".e-product-back").fadeIn();$('.product-item[data-sku="'+_sku+'"]').remove();setTimeout(function(){},3e3)})},back:function(){$(".e-product-back").click(function(event){var _element=$(this);_element.fadeOut();LivroFacil_Checkout.methods.addToCart(_last_sku,_last_json)})},addToCart:function(_last_sku,_last_json){var _tocart={id:_last_sku,quantity:1,seller:1,attachments:[{itemIndex:_index,name:"info",content:{aluno:_last_json}}]};vtexjs.checkout.addToCart([_tocart],"",3).done(function(orderForm){setTimeout(function(){},3e3)})},discount:function(){$("#cartLoadedDiv .product-item").each(function(index,el){var _element=$(this);if(_element.find(".old-product-price").text()!=""&&!_element.find(".e-off-discount").length){var price_de_lines=_element.find(".old-product-price").text().split(" ");var price_de=price_de_lines.length<2?0:price_de_lines[1].replace(".","").replace(",",".");var price_por_lines=_element.find(".new-product-price").text().split(" ");var price_por=price_por_lines.length<2?0:price_por_lines[1].replace(".","").replace(",",".");var discount=price_de===0?100:100-100*price_por/price_de;_element.find(".product-price").append('<div class="e-off-discount"><span class="e-discount">'+discount.toFixed(0)+"%</span> de desconto<span></span></div>")}})},showMore:function(){$("body").on("click","#show-more",function(event){setTimeout(function(){LivroFacil_Checkout.methods.nameStudent();LivroFacil_Checkout.methods.discount()},1e3)})},popupRedirect:{init:function(){this.close();this._handleSchoolInfo()},open:function(){this._togglePopup("add")},close:function(){var self=this;var closeBtn=document.getElementById("redirectPopupClose");closeBtn.addEventListener("click",function(ev){self._togglePopup("remove")})},_handleSchoolInfo:function(){if(window.sessionStorage.getItem("hasOpenedPopupRedirect")===null||window.sessionStorage.getItem("hasOpenedPopupRedirect")=="true"){window.sessionStorage.setItem("hasOpenedPopupRedirect",false)}else{return false}var self=this;var schoolId=self._getCookie("_schools_id");if(schoolId!==""){self._getSchoolInfo(schoolId).then(function(res){var mustSetPopup=self._hasUniformLink(res.linkUniforme);if(mustSetPopup){self._setPoupup(res)}}).fail(function(err){console.log("Error",err)})}},_getCookie:function(cname){var name=cname+"=";var decodedCookie=decodeURIComponent(document.cookie);var ca=decodedCookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" "){c=c.substring(1)}if(c.indexOf(name)==0){return c.substring(name.length,c.length)}}return""},_getSchoolInfo:function(schoolId){var options={headers:_headers,type:"GET",url:"/api/dataentities/ES/documents/"+schoolId+"?_fields=id,linkUniforme&an=livrofacil"};return $.ajax(options)},_hasUniformLink:function(uniformLink){return uniformLink!==null},_validateSchoolLink:function(str){var pattern=/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$/gm;var re=new RegExp(pattern);return re.test(str)},_setPoupup:function(responseObj){var self=this;self._setFakeButton();self._cartToOrderForm();var linkEl=document.getElementById("redirectPopupLink");var fakeButton=document.getElementById("ghostButton");linkEl.href=responseObj.linkUniforme;fakeButton.addEventListener("click",function(ev){window.sessionStorage.setItem("hasOpenedPopupRedirect",true);self.open();fakeButton.remove()})},_cartToOrderForm:function(){var self=this;var cartToOrderFormFakeBtn=document.getElementById("cartToOrderformFake");cartToOrderFormFakeBtn.addEventListener("click",function(ev){self._togglePopup("remove");document.getElementById("cart-to-orderform").click()})},_setFakeButton:function(){var cartToOrderformBtn=document.getElementById("cart-to-orderform");var fakeButton=Object.assign(document.createElement("div"),{className:"x-checkout__fake-button",id:"ghostButton"});cartToOrderformBtn.parentNode.insertBefore(fakeButton,cartToOrderformBtn.nextSibling)},_togglePopup:function(method){var popup=document.getElementById("redirectPopup");var cartEl=document.querySelectorAll(".container-cart")[0];popup.classList[method]("is--active");cartEl.classList[method]("is--blurred")}},zipCodeValidator:function(){var shippingData=vtexjs.checkout.orderForm.shippingData;var getCEP=$("#ship-postalCode").val();var getFinalNumbers;if(getCEP!=undefined){getFinalNumbers=getCEP.split("-");getFinalNumbers=getFinalNumbers[1];if(getFinalNumbers=="000"){$(".box-step .vtex-omnishipping-1-x-deliveryGroup").css("display","block");$(".box-step .vtex-omnishipping-1-x-addressForm").css("display","block");$(".box-step .vtex-omnishipping-1-x-submitPaymentButton").css("display","block")}else if(getFinalNumbers!="000"&&shippingData.address.street!=null){$(".box-step .vtex-omnishipping-1-x-deliveryGroup").css("display","block");$(".box-step .vtex-omnishipping-1-x-addressForm").css("display","block");$(".box-step .vtex-omnishipping-1-x-submitPaymentButton").css("display","block")}else{if(!$(".alert-cep").length){$("#ship-postalCode").removeClass("success");$('<div class="alert-cep"><span>!</span>CEP inválido ou inexistente, Tente outro CEP.</div>').insertBefore($(".ship-postalCode label[for=ship-postalCode]"));return}}}if(shippingData.logisticsInfo.length>0){if(shippingData.logisticsInfo[0].selectedDeliveryChannel==="pickup-in-point"){$(".box-step .vtex-omnishipping-1-x-deliveryGroup").css("display","block");$(".box-step .vtex-omnishipping-1-x-addressForm").css("display","block");$(".box-step .vtex-omnishipping-1-x-submitPaymentButton").css("display","block")}}},characterLimiterAddressForm:function(){$(".shipping-data input[name=complement]").attr("maxlength",60);$(".shipping-data input[name=number]").attr("maxlength",10)},separadorAluno:function(){$(".separator-cart").parents("tr").remove();$(".product-item .e-student").each(function(i,e){if($(".product-item").length!=$(".product-item .e-student").length&&i==0){$('<tr><td colspan="7" style=""><div class="separator-cart"></div></td></tr>').insertBefore($(e).parents(".product-item"))}else if($(e).html()!=$($(".product-item .e-student")[i-1]).html()){if($(e).closest(".product-item").html()!=$(".product-item").html()){$('<tr><td colspan="7" style=""><div class="separator-cart"></div></td></tr>').insertBefore($(e).parents(".product-item"))}}})},flagLivroDigital:function(){setTimeout(function(){$("table.table tr.product-item").each(function(index,element){var id=$(element).data("sku");$.ajax({url:"/api/catalog_system/pub/products/search?fq=skuId:"+id,type:"GET",dataType:"json",success:function(data){if(data[0].categoriesIds[0].indexOf("335")>-1){$(element).find(".product-name > a[id*='product-name']").after("<p class='tagLivroDigital'><strong>Produto digital:</strong> em até 24h será enviado por SMS o link de acesso ao Plurall - ao receber, compartilhe com o aluno.</p>")}}})})},3500)},init:function(){_carregando=false;setTimeout(function(){$($(".container-cart .loading.loading-bg")[0]).attr("style","display: none!important")},500);$(window).on("orderFormUpdated.vtex",function(){if(window.location.hash.includes("#/cart")){LivroFacil_Checkout.methods.nameStudent()}});this.newStudent();this.remove();this.back();this.showMore();this.flagLivroDigital();this.popupRedirect.init();$(window).on("hashchange",function(){LivroFacil_Checkout.methods.getDateShipping()})},init_ajax:function(){if(window.location.hash=="#/shipping"){this.zipCodeValidator()}this.characterLimiterAddressForm()},init_load:function(){}},ajax:function(){return this.methods.init_ajax()},load:function(){return this.methods.init_load()},mounted:function(){return this.methods.init()}};$(document).ready(function(){LivroFacil_Checkout.mounted()});$(document).ajaxStop(function(){LivroFacil_Checkout.ajax()});$(window).load(function(){LivroFacil_Checkout.load()});